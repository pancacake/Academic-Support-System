<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>æ™ºèƒ½å‡ºé¢˜ - å­¦æœ¯æ”¯æŒç³»ç»Ÿ</title>

    <!-- æ ¸å¿ƒJavaScriptå‡½æ•° - åœ¨é¡µé¢åŠ è½½å‰å®šä¹‰ -->
    <script>
        console.log('å®šä¹‰æ ¸å¿ƒJavaScriptå‡½æ•°...');

        // å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢é¢˜ç›®æ•°é‡è¾“å…¥æ¡†çŠ¶æ€
        function toggleQuestionCount(type) {
            console.log('toggleQuestionCount è¢«è°ƒç”¨ï¼Œå‚æ•°:', type);
            const checkbox = document.getElementById(type);
            const countInput = document.getElementById(type + 'Count');

            if (checkbox && countInput) {
                countInput.disabled = !checkbox.checked;
                console.log('åˆ‡æ¢é¢˜å‹:', type, 'é€‰ä¸­:', checkbox.checked, 'è¾“å…¥æ¡†ç¦ç”¨:', countInput.disabled);
            } else {
                console.error('æ‰¾ä¸åˆ°å…ƒç´ :', type, 'checkbox:', checkbox, 'countInput:', countInput);
            }
        }

        // å…¨å±€å‡½æ•°ï¼šå¼€å§‹å‡ºé¢˜æµç¨‹ï¼ˆå®é™…å®ç°åœ¨é¡µé¢åº•éƒ¨ï¼‰
        // startQuestionGeneration() å‡½æ•°åœ¨é¡µé¢åº•éƒ¨å®šä¹‰

        console.log('æ ¸å¿ƒJavaScriptå‡½æ•°å®šä¹‰å®Œæˆ');
        console.log('toggleQuestionCount:', typeof toggleQuestionCount);
        // startQuestionGenerationå‡½æ•°åœ¨é¡µé¢åº•éƒ¨å®šä¹‰
    </script>

    <!-- ç®€åŒ–çš„æ•°å­¦å…¬å¼æ”¯æŒ -->
    <script>
        // ç®€å•çš„æ•°å­¦å…¬å¼æ¸²æŸ“å™¨
        window.renderMathInElement = function(element) {
            if (!element) return;

            // ç®€å•çš„æ•°å­¦å…¬å¼æ ‡è®°å¤„ç†
            if (element.innerHTML) {
                element.innerHTML = element.innerHTML
                    .replace(/\$\$(.*?)\$\$/g, '<div class="math-display">$1</div>')
                    .replace(/\$(.*?)\$/g, '<span class="math-inline">$1</span>');
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåå¤„ç†æ•°å­¦å…¬å¼
        document.addEventListener('DOMContentLoaded', function() {
            const mathElements = document.querySelectorAll('.markdown-content, .question-text, .explanation');
            mathElements.forEach(el => {
                if (window.renderMathInElement) {
                    window.renderMathInElement(el);
                }
            });
        });
    </script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-size: 16px;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533483 75%, #2d1b69 100%);
            color: #e8eaed;
            min-height: 100vh;
            min-width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* æ·»åŠ åŠ¨æ€èƒŒæ™¯ç²’å­æ•ˆæœ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .topbar {
            width: 100vw;
            min-width: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 2rem;
            background: rgba(47, 47, 47, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            font-size: 1rem;
            font-weight: 500;
            box-sizing: border-box;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
            height: 60px;
        }
        .topbar .sysname {
            color: #ffffff;
            font-weight: 600;
        }
        .topbar .user-area {
            font-size: 1.2vw;
            font-weight: normal;
            background: rgba(255,255,255,0.1);
            padding: 0.5vw 1vw;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .main-layout {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar {
            width: 60px;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(79, 195, 247, 0.2);
            border-radius: 0 16px 16px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            z-index: 50;
            box-shadow: 4px 0 32px rgba(0, 0, 0, 0.3),
                        inset -1px 0 0 rgba(79, 195, 247, 0.1);
        }

        .sidebar:hover {
            width: 200px;
        }

        .sidebar-item {
            width: calc(100% - 1rem);
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #999;
            text-decoration: none;
            border-radius: 1rem;
            margin: 0 0.5rem 0.5rem 0.5rem;
            position: relative;
            overflow: hidden;
        }

        /* é»˜è®¤çŠ¶æ€ä¸‹å›¾æ ‡å±…ä¸­ */
        .sidebar-item .sidebar-icon {
            margin: 0 auto;
        }

        /* å±•å¼€æ—¶å›¾æ ‡å·¦å¯¹é½ */
        .sidebar:hover .sidebar-item .sidebar-icon {
            margin: 0;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 1rem;
        }

        .sidebar-item:hover::before {
            opacity: 1;
        }

        .sidebar-item:hover {
            color: #e8eaed;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            color: white;
            box-shadow: 0 4px 16px rgba(0, 132, 255, 0.3);
        }

        .sidebar-icon {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }

        .sidebar-text {
            margin-left: 1rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .sidebar-text {
            opacity: 1;
        }

        .container {
            display: flex;
            flex-direction: row;
            flex: 1;
            min-height: 0;
            padding: 0;
            gap: 0;
            box-sizing: border-box;
        }

        .chat-section {
            flex: 0 0 500px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            background: rgba(47, 47, 47, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid rgba(79, 195, 247, 0.2);
            border-radius: 0 0 16px 0;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2),
                        inset -1px 0 0 rgba(79, 195, 247, 0.1);
            min-width: 0;
            min-height: 0;
        }

        .questions-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            min-width: 0;
            min-height: 0;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin: 1rem;
        }

        .questions-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #e8eaed;
            background: linear-gradient(90deg,
                rgba(120, 119, 198, 0.15) 0%,
                rgba(255, 119, 198, 0.08) 50%,
                rgba(120, 219, 255, 0.15) 100%);
            position: relative;
            border-radius: 1.5rem 1.5rem 0 0;
        }

        .questions-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.1rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message.user {
            background: linear-gradient(135deg, rgba(0, 132, 255, 0.2), rgba(0, 102, 204, 0.1));
            border: 1px solid rgba(0, 132, 255, 0.3);
            margin-left: 2rem;
        }

        .message.system {
            background: linear-gradient(135deg, rgba(120, 119, 198, 0.2), rgba(255, 119, 198, 0.1));
            border: 1px solid rgba(120, 119, 198, 0.3);
            margin-right: 2rem;
        }

        .message-avatar {
            font-size: 1.5rem;
            min-width: 2rem;
            text-align: center;
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            color: #e8eaed;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 16px 0;
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            color: #e8eaed;
            font-size: 1rem;
            resize: none;
            min-height: 2.5rem;
            max-height: 8rem;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: rgba(79, 195, 247, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 132, 255, 0.3);
        }

        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-type {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .question-text {
            color: #e8eaed;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .question-options {
            margin: 1rem 0;
        }

        .option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e8eaed;
        }

        .option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(79, 195, 247, 0.5);
        }

        .option.selected {
            background: linear-gradient(135deg, rgba(0, 132, 255, 0.2), rgba(0, 102, 204, 0.1));
            border-color: rgba(0, 132, 255, 0.5);
            transform: translateX(5px);
        }

        .option.correct {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.2));
            border-color: #4caf50;
            color: #4caf50;
            animation: correctPulse 0.6s ease;
        }

        .option.incorrect {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(211, 47, 47, 0.2));
            border-color: #f44336;
            color: #f44336;
            animation: incorrectShake 0.6s ease;
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes correctPulse {
            0% { transform: scale(1) translateX(5px); }
            50% { transform: scale(1.05) translateX(5px); box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
            100% { transform: scale(1) translateX(5px); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(5px); }
            25% { transform: translateX(0px); }
            75% { transform: translateX(10px); }
        }

        .answer-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e8eaed;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .answer-input:focus {
            outline: none;
            border-color: rgba(79, 195, 247, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .answer-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .submit-answer-btn {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 132, 255, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preparing-message {
            text-align: center;
            color: #999;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        /* ç­”æ¡ˆåŒºåŸŸæ ·å¼ */
        .answer-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            border-left: 4px solid #0084ff;
            max-height: 60vh;
            overflow-y: auto;
        }

        .correct-answer {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 0.5rem;
        }

        .explanation {
            color: #e8eaed;
            line-height: 1.6;
        }

        /* Markdownå†…å®¹æ ·å¼ */
        .markdown-content {
            color: #e8eaed;
            line-height: 1.6;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            color: #4fc3f7;
            margin: 1rem 0 0.5rem 0;
            font-weight: bold;
        }

        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }

        .markdown-content p {
            margin: 0.5rem 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .markdown-content li {
            margin: 0.25rem 0;
        }

        .markdown-content strong {
            color: #81c784;
            font-weight: bold;
        }

        .markdown-content em {
            color: #ffb74d;
            font-style: italic;
        }

        .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            color: #f8bbd9;
        }

        .markdown-content pre {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #4fc3f7;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #b0bec5;
        }

        /* æ•°å­¦å…¬å¼æ ·å¼ */
        .math-display {
            text-align: center;
            margin: 16px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #4fc3f7;
        }

        .math-inline {
            display: inline;
            margin: 0 2px;
        }

        /* MathJaxå…ƒç´ æ ·å¼ */
        .MathJax {
            color: inherit !important;
        }

        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        /* é¢˜å‹é€‰æ‹©å¯¹è¯æ¡†æ ·å¼ */
        .question-type-dialog {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
        }

        .question-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-type-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .question-type-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }

        .question-type-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #4fc3f7;
        }

        .question-type-name {
            color: #e8eaed;
            font-size: 0.95rem;
        }

        .question-count-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #e8eaed;
            font-size: 0.9rem;
            width: 80px;
        }

        .question-count-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .question-count-input:enabled {
            border-color: #4fc3f7;
        }

        .dialog-actions {
            text-align: right;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.3);
        }

        .preference-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e8eaed;
            font-size: 0.95rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .preference-input:focus {
            outline: none;
            border-color: #4fc3f7;
            background: rgba(255, 255, 255, 0.15);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .question-type-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="topbar">
        <div class="sysname">çŸ¥æ‚ŸÂ·å¯æ˜å­¦ä¸šé—®ç­”ç³»ç»Ÿ</div>
        <div class="user-area" style="display: flex; align-items: center; gap: 1rem;">
            <span id="userInfo">è®¿å®¢ç”¨æˆ·</span>
            <button id="logoutBtn" style="
                background: rgba(79, 195, 247, 0.1);
                border: 1px solid rgba(79, 195, 247, 0.3);
                color: #e8eaed;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 0.9rem;
            " onclick="handleLogout()" onmouseover="this.style.background='rgba(79, 195, 247, 0.2)'" onmouseout="this.style.background='rgba(79, 195, 247, 0.1)'">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <a href="/" class="sidebar-item">
                <div class="sidebar-icon">ğŸ’¬</div>
                <div class="sidebar-text">èŠå¤©</div>
            </a>
            <a href="/mindmap/" class="sidebar-item">
                <div class="sidebar-icon">ğŸ§ </div>
                <div class="sidebar-text">æ€ç»´å¯¼å›¾</div>
            </a>
            <a href="/questions/" class="sidebar-item active">
                <div class="sidebar-icon">ğŸ“</div>
                <div class="sidebar-text">æ™ºèƒ½å‡ºé¢˜</div>
            </a>
        </div>

        <div class="container">
            <!-- å·¦ä¾§èŠå¤©åŒºåŸŸ -->
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <!-- åˆå§‹çš„é¢˜å‹é€‰æ‹©å¯¹è¯æ¡† -->
                    <div class="message system">
                        <div class="message-avatar">ğŸ“</div>
                        <div class="message-content">
                            <div class="question-type-dialog" id="questionTypeDialog">
                                <h3 style="margin-bottom: 1rem; color: #4fc3f7;">è¯·é€‰æ‹©é¢˜å‹å’Œæ•°é‡</h3>

                                <div class="question-type-grid">
                                    <div class="question-type-item">
                                        <label class="question-type-label">
                                            <input type="checkbox" id="multipleChoice" class="question-type-checkbox" checked onchange="toggleQuestionCount('multipleChoice')">
                                            <span class="question-type-name">é€‰æ‹©é¢˜</span>
                                        </label>
                                        <input type="number" id="multipleChoiceCount" class="question-count-input" min="1" max="20" value="5">
                                    </div>

                                    <div class="question-type-item">
                                        <label class="question-type-label">
                                            <input type="checkbox" id="fillBlank" class="question-type-checkbox" checked onchange="toggleQuestionCount('fillBlank')">
                                            <span class="question-type-name">å¡«ç©ºé¢˜</span>
                                        </label>
                                        <input type="number" id="fillBlankCount" class="question-count-input" min="1" max="20" value="3">
                                    </div>

                                    <div class="question-type-item">
                                        <label class="question-type-label">
                                            <input type="checkbox" id="trueOrFalse" class="question-type-checkbox" checked onchange="toggleQuestionCount('trueOrFalse')">
                                            <span class="question-type-name">åˆ¤æ–­é¢˜</span>
                                        </label>
                                        <input type="number" id="trueOrFalseCount" class="question-count-input" min="1" max="20" value="5">
                                    </div>

                                    <div class="question-type-item">
                                        <label class="question-type-label">
                                            <input type="checkbox" id="shortAnswer" class="question-type-checkbox" checked onchange="toggleQuestionCount('shortAnswer')">
                                            <span class="question-type-name">è§£ç­”é¢˜</span>
                                        </label>
                                        <input type="number" id="shortAnswerCount" class="question-count-input" min="1" max="10" value="2">
                                    </div>
                                </div>

                                <div class="dialog-actions">
                                    <button class="confirm-btn" onclick="startQuestionGeneration()">ç¡®è®¤é€‰æ‹©</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea
                            id="chatInput"
                            class="chat-input"
                            placeholder="è¯·æè¿°æ‚¨çš„å‡ºé¢˜éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘å¸Œæœ›é¢˜ç›®å¯ä»¥å¤šè€ƒå¯Ÿä¸€äº›åŸºç¡€å†…å®¹"
                            rows="1"
                        ></textarea>
                        <button class="send-btn" onclick="sendMessage()">
                            â¤
                        </button>
                        <button onclick="debugAPI()" style="margin-left: 10px; padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">è°ƒè¯•API</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢˜ç›®å±•ç¤ºåŒºåŸŸ -->
            <div class="questions-section">
                <div class="questions-header">
                    <span>ğŸ“ é¢˜ç›®å±•ç¤º</span>
                </div>
                <div class="questions-content" id="questionsContent">
                    <div class="preparing-message">
                        <div>è¯·åœ¨å·¦ä¾§å¯¹è¯æ¡†ä¸­æè¿°æ‚¨çš„å‡ºé¢˜éœ€æ±‚</div>
                        <div style="font-size: 0.9rem; color: #666;">ä¾‹å¦‚ï¼šæˆ‘å¸Œæœ›é¢˜ç›®å¯ä»¥å¤šè€ƒå¯Ÿä¸€äº›åŸºç¡€å†…å®¹</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let isGenerating = false;
        let selectedQuestionTypes = {};
        let userPreferences = '';
        let isWaitingForPreferences = false;

        // å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢é¢˜ç›®æ•°é‡è¾“å…¥æ¡†çŠ¶æ€
        function toggleQuestionCount(type) {
            console.log('toggleQuestionCount è¢«è°ƒç”¨ï¼Œå‚æ•°:', type);
            const checkbox = document.getElementById(type);
            const countInput = document.getElementById(type + 'Count');

            if (checkbox && countInput) {
                countInput.disabled = !checkbox.checked;
                console.log('åˆ‡æ¢é¢˜å‹:', type, 'é€‰ä¸­:', checkbox.checked, 'è¾“å…¥æ¡†ç¦ç”¨:', countInput.disabled);
            } else {
                console.error('æ‰¾ä¸åˆ°å…ƒç´ :', type, 'checkbox:', checkbox, 'countInput:', countInput);
            }
        }

        // å…¨å±€å‡½æ•°ï¼šå¼€å§‹å‡ºé¢˜æµç¨‹
        function startQuestionGeneration() {
            console.log('startQuestionGeneration è¢«è°ƒç”¨');

            // è°ƒè¯•ï¼šç¡®è®¤å‡½æ•°è¢«æ­£ç¡®è°ƒç”¨
            console.log('å‡½æ•° startQuestionGeneration æ­£åœ¨æ‰§è¡Œ...');

            const types = ['multipleChoice', 'fillBlank', 'trueOrFalse', 'shortAnswer'];
            const typeNames = {
                'multipleChoice': 'é€‰æ‹©é¢˜',
                'fillBlank': 'å¡«ç©ºé¢˜',
                'trueOrFalse': 'åˆ¤æ–­é¢˜',
                'shortAnswer': 'è§£ç­”é¢˜'
            };

            let selectedTypes = {};
            let hasSelection = false;
            let selectionText = 'æ‚¨é€‰æ‹©äº†ï¼š';

            types.forEach(type => {
                const checkbox = document.getElementById(type);
                const countInput = document.getElementById(type + 'Count');

                console.log('æ£€æŸ¥é¢˜å‹:', type, 'å¤é€‰æ¡†:', checkbox ? checkbox.checked : 'null', 'è¾“å…¥æ¡†:', countInput ? countInput.value : 'null');

                if (checkbox && checkbox.checked && countInput) {
                    const count = parseInt(countInput.value) || 0;
                    if (count > 0) {
                        selectedTypes[type] = {
                            name: typeNames[type],
                            count: count
                        };
                        hasSelection = true;
                        selectionText += count + 'é“' + typeNames[type] + 'ã€';
                    }
                }
            });

            console.log('é€‰æ‹©çš„é¢˜å‹:', selectedTypes);

            if (!hasSelection) {
                showErrorMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹ï¼');
                return;
            }

            // ç§»é™¤æœ€åçš„é¡¿å·
            selectionText = selectionText.slice(0, -1);

            // éšè—é¢˜å‹é€‰æ‹©å¯¹è¯æ¡†
            const dialog = document.getElementById('questionTypeDialog');
            if (dialog) {
                dialog.style.display = 'none';
            }

            // æ›´æ–°å…¨å±€å˜é‡
            selectedQuestionTypes = selectedTypes;

            // æ·»åŠ ç¡®è®¤æ¶ˆæ¯
            addMessage(selectionText, 'user');

            // è°ƒç”¨å®é™…çš„é¢˜ç›®ç”Ÿæˆå‡½æ•°
            generateQuestions();
        }

        // è·å–CSRF token
        function getCookie(name) {
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }

            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // å˜é‡å·²åœ¨ä¸Šé¢å£°æ˜

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message, details = null) {
            console.error('é”™è¯¯:', message, details);

            // æ„å»ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
            let userMessage = message;
            if (message.includes('API') || message.includes('ç½‘ç»œ')) {
                userMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
            } else if (message.includes('ç¬”è®°') || message.includes('å†…å®¹')) {
                userMessage = 'è¯·å…ˆä¸Šä¼ æ–‡æ¡£å¹¶ç”Ÿæˆç¬”è®°å†…å®¹';
            } else if (message.includes('æ ¼å¼') || message.includes('è§£æ')) {
                userMessage = 'æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•';
            }

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            if (typeof addMessage === 'function') {
                addMessage(`âŒ ${userMessage}`, 'system');
            } else {
                alert(userMessage);
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            console.log('æˆåŠŸ:', message);
            if (typeof addMessage === 'function') {
                addMessage('âœ… ' + message, 'system');
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
        function showWarningMessage(message) {
            console.warn('è­¦å‘Š:', message);
            if (typeof addMessage === 'function') {
                addMessage('âš ï¸ ' + message, 'system');
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoadingState(message = 'æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...') {
            const questionsContent = document.getElementById('questionsContent');
            if (questionsContent) {
                questionsContent.innerHTML = `
                    <div class="preparing-message">
                        <div class="loading-spinner"></div>
                        <div>${message}</div>
                    </div>
                `;
            }
        }

        // å·¥å…·å‡½æ•°ï¼šå¤„ç†APIå“åº”
        function handleApiResponse(data, successCallback, errorCallback) {
            if (data.success) {
                if (data.message) {
                    showSuccessMessage(data.message);
                }
                if (successCallback) {
                    successCallback(data);
                }
            } else {
                const errorMsg = data.error || 'æ“ä½œå¤±è´¥';
                showErrorMessage(errorMsg, data);
                if (errorCallback) {
                    errorCallback(data);
                }
            }
        }



        // ç¡®è®¤é¢˜å‹é€‰æ‹©ï¼ˆå·²åˆå¹¶åˆ°startQuestionGenerationä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰
        function confirmQuestionTypes() {
            console.log('confirmQuestionTypesè¢«è°ƒç”¨ï¼Œé‡å®šå‘åˆ°startQuestionGeneration');
            startQuestionGeneration();
        }

        // è¯¢é—®ç”¨æˆ·åå¥½
        function askForPreferences() {
            isWaitingForPreferences = true;
            let countdown = 10;

            // æ˜¾ç¤ºåˆå§‹æ¶ˆæ¯
            const initialMessage = 'å¦‚æœæ‚¨æœ‰ç‰¹æ®Šçš„å‡ºé¢˜åå¥½ï¼ˆå¦‚é‡ç‚¹è€ƒæŸ¥æ¦‚å¿µç†è§£ã€å¢åŠ å®é™…åº”ç”¨åœºæ™¯ã€éš¾åº¦é€‚ä¸­ç­‰ï¼‰ï¼Œè¯·ç›´æ¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å°†åœ¨ **' + countdown + '** ç§’åå¼€å§‹è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®ã€‚';
            addMessage(initialMessage, 'system');

            // å¼€å§‹å€’è®¡æ—¶
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0 && isWaitingForPreferences) {
                    // æ›´æ–°å€’è®¡æ—¶æ¶ˆæ¯
                    const countdownMessage = 'å¦‚æœæ‚¨æœ‰ç‰¹æ®Šçš„å‡ºé¢˜åå¥½ï¼ˆå¦‚é‡ç‚¹è€ƒæŸ¥æ¦‚å¿µç†è§£ã€å¢åŠ å®é™…åº”ç”¨åœºæ™¯ã€éš¾åº¦é€‚ä¸­ç­‰ï¼‰ï¼Œè¯·ç›´æ¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å°†åœ¨ **' + countdown + '** ç§’åå¼€å§‹è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®ã€‚';
                    updateLastSystemMessage(countdownMessage);
                } else {
                    clearInterval(countdownInterval);
                    if (isWaitingForPreferences) {
                        skipPreferences();
                    }
                }
            }, 1000);

            // ä¿å­˜å€’è®¡æ—¶IDä»¥ä¾¿æ¸…é™¤
            window.preferenceCountdownInterval = countdownInterval;
        }

        // ç¡®è®¤ç”¨æˆ·åå¥½
        function confirmPreferences() {
            const preferenceInput = document.getElementById('preferenceInput');
            userPreferences = preferenceInput.value.trim();

            if (userPreferences) {
                addMessage('åå¥½è®¾ç½®ï¼š' + userPreferences, 'user');
            } else {
                addMessage('å·²è·³è¿‡åå¥½è®¾ç½®', 'user');
            }

            isWaitingForPreferences = false;
            generateQuestions();
        }

        // è·³è¿‡åå¥½è®¾ç½®
        function skipPreferences() {
            userPreferences = '';
            addMessage('å·²è·³è¿‡åå¥½è®¾ç½®', 'user');
            isWaitingForPreferences = false;
            generateQuestions();
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message || isGenerating || isWaitingForPreferences) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            chatInput.value = '';

            // å¦‚æœæ­£åœ¨ç­‰å¾…åå¥½è¾“å…¥
            if (isWaitingForPreferences) {
                // æ¸…é™¤å€’è®¡æ—¶
                if (window.preferenceCountdownInterval) {
                    clearInterval(window.preferenceCountdownInterval);
                }

                userPreferences = message;
                addMessage('å·²æ”¶åˆ°æ‚¨çš„åå¥½è®¾ç½®ï¼š**' + message + '**', 'system');
                isWaitingForPreferences = false;
                generateQuestions();
                return;
            }

            // ç®€å•å›å¤ï¼Œå¼•å¯¼ç”¨æˆ·ä½¿ç”¨é¢˜å‹é€‰æ‹©åŠŸèƒ½
            addMessage('è¯·ä½¿ç”¨ä¸Šæ–¹çš„é¢˜å‹é€‰æ‹©åŠŸèƒ½æ¥ç”Ÿæˆé¢˜ç›®ï¼Œæˆ–è€…åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚', 'system');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(content, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;

            const avatar = type === 'user' ? 'ğŸ‘¤' : 'ğŸ“';

            // æ¸²æŸ“Markdownå†…å®¹
            const renderedContent = renderMarkdown(content);

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content markdown-content">${renderedContent}</div>
            `;

            chatMessages.appendChild(messageDiv);

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (window.renderMathInElement) {
                window.renderMathInElement(messageDiv);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ›´æ–°æœ€åä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯
        function updateLastSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const systemMessages = chatMessages.querySelectorAll('.message.system');

            if (systemMessages.length > 0) {
                const lastSystemMessage = systemMessages[systemMessages.length - 1];
                const messageContent = lastSystemMessage.querySelector('.message-content');

                // æ¸²æŸ“Markdownå†…å®¹
                const renderedContent = renderMarkdown(content);
                messageContent.innerHTML = renderedContent;

                // æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.renderMathInElement) {
                    window.renderMathInElement(messageContent);
                }
            }
        }

        // ç”Ÿæˆé¢˜ç›®
        async function generateQuestions() {
            if (isGenerating) {
                console.log('é¢˜ç›®ç”Ÿæˆä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }

            isGenerating = true;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoadingState('æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...');
            addMessage('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...', 'system');

            try {
                // éªŒè¯é€‰æ‹©çš„é¢˜å‹
                if (!selectedQuestionTypes || Object.keys(selectedQuestionTypes).length === 0) {
                    throw new Error('è¯·å…ˆé€‰æ‹©é¢˜ç›®ç±»å‹');
                }

                // æ„å»ºé¢˜å‹è¦æ±‚æ–‡æœ¬
                let requirementText = 'è¯·ç”Ÿæˆä»¥ä¸‹é¢˜ç›®ï¼š';
                Object.values(selectedQuestionTypes).forEach(type => {
                    requirementText += type.count + 'é“' + type.name + 'ã€';
                });
                requirementText = requirementText.slice(0, -1);

                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData = {
                    selected_types: selectedQuestionTypes,
                    preferences: userPreferences || '',
                    requirement_text: requirementText
                };

                console.log('å‘é€è¯·æ±‚æ•°æ®:', requestData);

                // å¢åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.log('è¯·æ±‚è¶…æ—¶ï¼Œå·²å–æ¶ˆ');
                }, 60000); // 60ç§’è¶…æ—¶

                const response = await fetch('/questions/generate-structured/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    credentials: 'same-origin',
                    signal: controller.signal,
                    body: JSON.stringify(requestData)
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°å“åº”æ•°æ®:', data);

                if (data.success) {
                    currentQuestions = data.questions || [];
                    currentQuestionIndex = 0;

                    if (currentQuestions.length > 0) {
                        displayQuestionsOneByOne();
                        const summaryMessage = data.questions_summary || `æˆåŠŸç”Ÿæˆäº† ${currentQuestions.length} é“é¢˜ç›®ï¼`;
                        addMessage(summaryMessage, 'system');
                    } else {
                        throw new Error('æœªç”Ÿæˆä»»ä½•é¢˜ç›®ï¼Œè¯·æ£€æŸ¥ç¬”è®°å†…å®¹');
                    }
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆé¢˜ç›®å¤±è´¥');
                }

            } catch (error) {
                console.error('ç”Ÿæˆé¢˜ç›®å¤±è´¥:', error);

                let errorMessage = error.message;
                let errorDetails = '';

                // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                    errorDetails = 'é¢˜ç›®ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š';
                } else if (error.message.includes('Connection') || error.message.includes('connection')) {
                    errorMessage = 'APIè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”';
                    errorDetails = 'ç½‘ç»œè¿æ¥å¯èƒ½ä¸ç¨³å®šï¼Œç³»ç»Ÿå·²æä¾›å¤‡ç”¨é¢˜ç›®';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
                    errorDetails = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                }

                showErrorMessage(errorMessage);

                // æ›´æ–°UIæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                const questionsContent = document.getElementById('questionsContent');
                if (questionsContent) {
                    questionsContent.innerHTML = `
                        <div class="preparing-message">
                            <div>âŒ ç”Ÿæˆé¢˜ç›®å¤±è´¥</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">${errorMessage}</div>
                            ${errorDetails ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.3rem;">${errorDetails}</div>` : ''}
                            <button class="confirm-btn" onclick="generateQuestions()" style="margin-top: 1rem;">é‡è¯•</button>
                            <button class="confirm-btn" onclick="debugAPI()" style="margin-top: 0.5rem; margin-left: 0.5rem; background: #6c757d;">è°ƒè¯•ä¿¡æ¯</button>
                        </div>
                    `;
                }
            } finally {
                isGenerating = false;
            }
        }

        // é€ä¸€æ˜¾ç¤ºé¢˜ç›®
        function displayQuestionsOneByOne() {
            const questionsContent = document.getElementById('questionsContent');

            if (!currentQuestions || currentQuestions.length === 0) {
                questionsContent.innerHTML = `
                    <div class="preparing-message">
                        <div>æš‚æ— é¢˜ç›®</div>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºå½“å‰é¢˜ç›®
            displayCurrentQuestion();
        }

        // æ˜¾ç¤ºå½“å‰é¢˜ç›®
        function displayCurrentQuestion() {
            const questionsContent = document.getElementById('questionsContent');

            if (currentQuestionIndex >= currentQuestions.length) {
                questionsContent.innerHTML = `
                    <div class="preparing-message">
                        <div>ğŸ‰ æ‰€æœ‰é¢˜ç›®å·²å®Œæˆï¼</div>
                        <div style="font-size: 0.9rem; color: #666;">æ‚¨å·²å®Œæˆæ‰€æœ‰ ${currentQuestions.length} é“é¢˜ç›®</div>
                        <button class="confirm-btn" onclick="restartQuestions()" style="margin-top: 1rem;">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            let html = `
                <div class="question-card" id="question-${currentQuestionIndex}">
                    <div class="question-header">
                        <span class="question-type">${question.type || 'é¢˜ç›®'}</span>
                        <span>ç¬¬ ${currentQuestionIndex + 1} é¢˜ / å…± ${currentQuestions.length} é¢˜</span>
                    </div>
                    <div class="question-text">${question.text}</div>
            `;

            if (question.options && question.options.length > 0) {
                html += '<div class="question-options">';
                question.options.forEach((option, optionIndex) => {
                    html += '<div class="option" onclick="selectOption(' + currentQuestionIndex + ', ' + optionIndex + ')">' + option + '</div>';
                });
                html += '</div>';
            } else {
                // å¡«ç©ºé¢˜æˆ–ç®€ç­”é¢˜
                html += '<textarea class="answer-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..." rows="3"></textarea>';
            }

            // æ·»åŠ é¢˜ç›®å¯¼èˆª
            html += '<div class="question-navigation" style="margin: 1rem 0; text-align: center;">';

            // é¢˜ç›®è¿›åº¦æŒ‡ç¤ºå™¨
            html += '<div class="question-progress" style="margin-bottom: 1rem;">';
            for (let i = 0; i < currentQuestions.length; i++) {
                const isActive = i === currentQuestionIndex;
                const progressClass = isActive ? 'active' : '';
                html += `<span class="progress-dot ${progressClass}" onclick="goToQuestion(${i})" style="
                    display: inline-block;
                    width: 30px;
                    height: 30px;
                    line-height: 30px;
                    text-align: center;
                    margin: 0 2px;
                    border-radius: 50%;
                    background: ${isActive ? '#007bff' : '#e9ecef'};
                    color: ${isActive ? 'white' : '#6c757d'};
                    cursor: pointer;
                    font-size: 12px;
                    border: 1px solid ${isActive ? '#007bff' : '#dee2e6'};
                ">${i + 1}</span>`;
            }
            html += '</div>';

            html += `
                    <div class="question-actions">
                        <button class="submit-answer-btn" onclick="showAnswer(${currentQuestionIndex})">æŸ¥çœ‹ç­”æ¡ˆ</button>
                    </div>

                    <!-- å¯¼èˆªæŒ‰é’® -->
                    <div class="navigation-buttons" style="margin-top: 1rem; text-align: center;">
                        <button class="submit-answer-btn" onclick="previousQuestion()"
                                ${currentQuestionIndex === 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                            â† ä¸Šä¸€é¢˜
                        </button>
                        <button class="submit-answer-btn" onclick="nextQuestion()" style="margin-left: 0.5rem;">
                            ${currentQuestionIndex === currentQuestions.length - 1 ? 'å®Œæˆç­”é¢˜' : 'ä¸‹ä¸€é¢˜ â†’'}
                        </button>
                    </div>

                    <div class="answer-section" id="answer-${currentQuestionIndex}" style="display: none;">
                        <div class="correct-answer">æ­£ç¡®ç­”æ¡ˆ: ${question.answer}</div>
                        <div class="explanation markdown-content">${question.explanation || 'æš‚æ— è§£æ'}</div>
                        <div class="answer-actions" style="margin-top: 1rem; text-align: center;">
                            <button class="submit-answer-btn" onclick="previousQuestion()"
                                    ${currentQuestionIndex === 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                                â† ä¸Šä¸€é¢˜
                            </button>
                            <button class="submit-answer-btn" onclick="nextQuestion()" style="margin-left: 0.5rem;">
                                ${currentQuestionIndex === currentQuestions.length - 1 ? 'å®Œæˆç­”é¢˜' : 'ä¸‹ä¸€é¢˜ â†’'}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            questionsContent.innerHTML = html;

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (window.renderMathInElement) {
                window.renderMathInElement(questionsContent);
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                // æ‰€æœ‰é¢˜ç›®å®Œæˆ
                showCompletionMessage();
            }
        }

        // ä¸Šä¸€é¢˜
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
        function goToQuestion(index) {
            if (index >= 0 && index < currentQuestions.length) {
                currentQuestionIndex = index;
                displayCurrentQuestion();
            }
        }

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        function showCompletionMessage() {
            const questionsContent = document.getElementById('questionsContent');
            if (questionsContent) {
                questionsContent.innerHTML = `
                    <div class="preparing-message">
                        <div>ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰é¢˜ç›®ï¼</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                            æ‚¨å·²å®Œæˆäº† ${currentQuestions.length} é“é¢˜ç›®
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="confirm-btn" onclick="generateAnswerReport()" style="margin-right: 0.5rem;">æŸ¥çœ‹ç­”é¢˜æŠ¥å‘Š</button>
                            <button class="confirm-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
                        </div>
                    </div>
                `;
            }
        }

        // é‡æ–°å¼€å§‹
        function restartQuestions() {
            currentQuestionIndex = 0;
            location.reload(); // åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(questionIndex, optionIndex) {
            const questionCard = document.getElementById('question-' + questionIndex);
            if (!questionCard) return;

            const options = questionCard.querySelectorAll('.option');
            const selectedOption = options[optionIndex];
            const question = currentQuestions[questionIndex];

            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });

            // æ ‡è®°å½“å‰é€‰æ‹©
            selectedOption.classList.add('selected');

            // æ£€æŸ¥ç­”æ¡ˆ
            const userAnswer = selectedOption.textContent.trim();
            const correctAnswer = question.answer;
            const isCorrect = checkAnswer(userAnswer, correctAnswer, question.type);

            // æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯æ•ˆæœ
            setTimeout(() => {
                if (isCorrect) {
                    selectedOption.classList.remove('selected');
                    selectedOption.classList.add('correct');
                } else {
                    selectedOption.classList.remove('selected');
                    selectedOption.classList.add('incorrect');

                    // åŒæ—¶é«˜äº®æ­£ç¡®ç­”æ¡ˆ
                    options.forEach(option => {
                        if (checkAnswer(option.textContent.trim(), correctAnswer, question.type)) {
                            option.classList.add('correct');
                        }
                    });
                }

                // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
                options.forEach(option => {
                    option.classList.add('disabled');
                });

                // æ˜¾ç¤ºè§£æ
                showAnswerExplanation(questionIndex, isCorrect);

            }, 300); // å»¶è¿Ÿ300msæ˜¾ç¤ºç»“æœï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©æ•ˆæœ
        }

        // ç®€åŒ–çš„Markdownæ¸²æŸ“å™¨
        function renderMarkdown(text) {
            if (!text) return text;

            // å…ˆå¤„ç†æ¢è¡Œ
            let result = text.replace(/\n/g, '<br>');

            // å¤„ç†æ ‡é¢˜
            result = result.replace(/^### (.*?)(<br>|$)/gm, '<h3>$1</h3>$2');
            result = result.replace(/^## (.*?)(<br>|$)/gm, '<h2>$1</h2>$2');
            result = result.replace(/^# (.*?)(<br>|$)/gm, '<h1>$1</h1>$2');

            // å¤„ç†ç²—ä½“
            result = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // å¤„ç†æ–œä½“
            result = result.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');

            // å¤„ç†ä»£ç 
            result = result.replace(/`([^`]+?)`/g, '<code>$1</code>');

            // å¤„ç†åˆ—è¡¨é¡¹
            result = result.replace(/^[\*\-] (.*?)(<br>|$)/gm, '<li>$1</li>$2');

            // å¤„ç†å¼•ç”¨
            result = result.replace(/^> (.*?)(<br>|$)/gm, '<blockquote>$1</blockquote>$2');

            return result;
        }

        // æ˜¾ç¤ºç­”æ¡ˆè§£æ
        function showAnswerExplanation(questionIndex, isCorrect) {
            const question = currentQuestions[questionIndex];
            const answerSection = document.getElementById('answer-' + questionIndex);

            if (answerSection) {
                // æ›´æ–°ç­”æ¡ˆåŒºåŸŸå†…å®¹
                const resultIcon = isCorrect ? 'âœ…' : 'âŒ';
                const resultText = isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯';
                const resultColor = isCorrect ? '#4caf50' : '#f44336';

                // æ¸²æŸ“Markdownå†…å®¹
                const renderedExplanation = renderMarkdown(question.explanation || 'æš‚æ— è§£æ');

                answerSection.innerHTML = `
                    <div style="color: ${resultColor}; font-weight: bold; margin-bottom: 0.5rem;">
                        ${resultIcon} ${resultText}
                    </div>
                    <div class="correct-answer">æ­£ç¡®ç­”æ¡ˆ: ${question.answer}</div>
                    <div class="explanation markdown-content">${renderedExplanation}</div>
                    <div class="answer-actions" style="margin-top: 1rem; text-align: center;">
                        <button class="submit-answer-btn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
                    </div>
                `;

                // æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.renderMathInElement) {
                    window.renderMathInElement(answerSection);
                }
                answerSection.style.display = 'block';

                // æ·»åŠ åˆ°èŠå¤©è®°å½•
                let feedback = 'ç¬¬' + (questionIndex + 1) + 'é¢˜ï¼š' + resultText;
                if (question.explanation) {
                    feedback += ' ' + question.explanation;
                }
                addMessage(feedback, 'system');
            }
        }

        // æäº¤ç­”æ¡ˆï¼ˆä¿ç•™ç”¨äºå¡«ç©ºé¢˜å’Œç®€ç­”é¢˜ï¼‰
        function submitAnswer(questionIndex, userAnswer) {
            const question = currentQuestions[questionIndex];

            // æäº¤ç­”æ¡ˆåˆ°æœåŠ¡å™¨
            submitAnswerToServer(question, userAnswer, questionIndex);
        }

        // æäº¤ç­”æ¡ˆåˆ°æœåŠ¡å™¨
        async function submitAnswerToServer(question, userAnswer, questionIndex = null) {
            try {
                const sessionId = generateSessionId();
                const index = questionIndex !== null ? questionIndex : currentQuestionIndex;

                const submitData = {
                    session_id: sessionId,
                    question_index: index,
                    question_type: question.type,
                    question_text: question.text,
                    user_answer: userAnswer,
                    correct_answer: question.answer,
                    time_spent: 0 // å¯ä»¥åç»­æ·»åŠ è®¡æ—¶åŠŸèƒ½
                };

                const response = await fetch('/questions/submit-answer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(submitData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // æ˜¾ç¤ºç­”æ¡ˆå’Œè§£æ
                        const isCorrect = result.is_correct;
                        showAnswerExplanation(index, isCorrect);

                        // åœ¨å·¦ä¾§å¯¹è¯æ¡†æ˜¾ç¤ºè§£æ
                        addMessage(result.explanation, 'system');
                    } else {
                        console.error('æäº¤ç­”æ¡ˆå¤±è´¥:', result.error);
                        // å¤‡ç”¨å¤„ç†
                        const isCorrect = checkAnswer(userAnswer, question.answer, question.type);
                        showAnswerExplanation(index, isCorrect);
                    }
                } else {
                    console.error('æäº¤ç­”æ¡ˆè¯·æ±‚å¤±è´¥:', response.status);
                    // å¤‡ç”¨å¤„ç†
                    const isCorrect = checkAnswer(userAnswer, question.answer, question.type);
                    showAnswerExplanation(index, isCorrect);
                }
            } catch (error) {
                console.error('æäº¤ç­”æ¡ˆå¼‚å¸¸:', error);
                // å¤‡ç”¨å¤„ç†
                const isCorrect = checkAnswer(userAnswer, question.answer, question.type);
                showAnswerExplanation(questionIndex !== null ? questionIndex : currentQuestionIndex, isCorrect);
            }
        }

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            if (!window.currentSessionId) {
                window.currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            return window.currentSessionId;
        }

        // ç”Ÿæˆç­”é¢˜æŠ¥å‘Š
        async function generateAnswerReport() {
            try {
                const sessionId = generateSessionId();

                const response = await fetch('/questions/generate-report/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayAnswerReport(result.report);
                    } else {
                        // å¦‚æœæ²¡æœ‰ç­”é¢˜è®°å½•ï¼Œæç¤ºç”¨æˆ·å…ˆç­”é¢˜
                        if (result.error && result.error.includes('æœªæ‰¾åˆ°ç­”é¢˜è®°å½•')) {
                            addMessage('ğŸ“ è¿˜æ²¡æœ‰ç­”é¢˜è®°å½•ï¼Œè¯·å…ˆå®Œæˆé¢˜ç›®åå†æŸ¥çœ‹æŠ¥å‘Š', 'system');
                            addMessage('ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥å…ˆç”Ÿæˆé¢˜ç›®å¹¶ä½œç­”ï¼Œç„¶åå†æŸ¥çœ‹ç­”é¢˜æŠ¥å‘Š', 'system');
                        } else {
                            addMessage('âŒ ç”Ÿæˆç­”é¢˜æŠ¥å‘Šå¤±è´¥ï¼š' + result.error, 'system');
                        }

                        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (result.debug_info) {
                            console.log('ç­”é¢˜æŠ¥å‘Šè°ƒè¯•ä¿¡æ¯:', result.debug_info);
                        }
                    }
                } else {
                    addMessage('âŒ ç”Ÿæˆç­”é¢˜æŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'system');
                }
            } catch (error) {
                console.error('ç”Ÿæˆç­”é¢˜æŠ¥å‘Šå¼‚å¸¸:', error);
                addMessage('âŒ ç”Ÿæˆç­”é¢˜æŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'system');
            }
        }

        // æ˜¾ç¤ºç­”é¢˜æŠ¥å‘Š
        function displayAnswerReport(report) {
            const summary = report.summary;
            const accuracy = summary.accuracy || 0;

            let reportMessage = `ğŸ“Š **ç­”é¢˜æŠ¥å‘Š**\n\n`;
            reportMessage += `ğŸ“ˆ **æ€»ä½“è¡¨ç°**\n`;
            reportMessage += `- æ€»é¢˜æ•°ï¼š${summary.total_questions}é“\n`;
            reportMessage += `- æ­£ç¡®é¢˜æ•°ï¼š${summary.correct_count}é“\n`;
            reportMessage += `- æ­£ç¡®ç‡ï¼š${accuracy}%\n\n`;

            if (summary.type_stats && Object.keys(summary.type_stats).length > 0) {
                reportMessage += `ğŸ“‹ **å„é¢˜å‹è¡¨ç°**\n`;
                for (const [type, stats] of Object.entries(summary.type_stats)) {
                    const typeAccuracy = stats.total > 0 ? (stats.correct / stats.total * 100).toFixed(1) : 0;
                    reportMessage += `- ${type}ï¼š${stats.correct}/${stats.total} (${typeAccuracy}%)\n`;
                }
                reportMessage += `\n`;
            }

            if (report.ai_analysis) {
                reportMessage += `ğŸ¤– **AIåˆ†æ**\n${report.ai_analysis}\n\n`;
            }

            if (report.weak_points && report.weak_points.length > 0) {
                reportMessage += `âš ï¸ **éœ€è¦åŠ å¼ºçš„é¢˜ç›®**\n`;
                report.weak_points.forEach((point, index) => {
                    reportMessage += `${index + 1}. ${point.question.substring(0, 50)}...\n`;
                });
                reportMessage += `\n`;
            }

            if (report.recommendations && report.recommendations.length > 0) {
                reportMessage += `ğŸ’¡ **å­¦ä¹ å»ºè®®**\n`;
                report.recommendations.forEach((rec, index) => {
                    reportMessage += `${index + 1}. ${rec}\n`;
                });
            }

            addMessage(reportMessage, 'system');
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(userAnswer, correctAnswer, questionType) {
            if (!userAnswer) return false;

            userAnswer = userAnswer.trim().toLowerCase();
            correctAnswer = correctAnswer.trim().toLowerCase();

            if (questionType === 'é€‰æ‹©é¢˜') {
                // æå–é€‰é¡¹å­—æ¯
                const userOption = userAnswer.match(/^([abcd])/);
                const correctOption = correctAnswer.match(/^([abcd])/);

                if (userOption && correctOption) {
                    return userOption[1] === correctOption[1];
                }
            }

            return userAnswer === correctAnswer || userAnswer.includes(correctAnswer);
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer(questionIndex) {
            const answerSection = document.getElementById('answer-' + questionIndex);
            answerSection.style.display = answerSection.style.display === 'none' ? 'block' : 'none';
        }

        // å¤„ç†å›è½¦é”®å‘é€æ¶ˆæ¯
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });



        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        async function checkUserStatus() {
            try {
                console.log('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€...');
                const response = await fetch('/users/api/current-user/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('ç”¨æˆ·çŠ¶æ€å“åº”:', data);
                    const userInfo = document.getElementById('userInfo');

                    if (data.success && data.user && data.user.is_authenticated) {
                        console.log('ç”¨æˆ·å·²ç™»å½•:', data.user.username);
                        // è®¾ç½®å…¨å±€ç”¨æˆ·ID
                        window.currentUserId = data.user.id;

                        userInfo.textContent = 'æ¬¢è¿ï¼Œ' + data.user.username;
                    } else {
                        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ£€æŸ¥æ¸¸å®¢æ¨¡å¼');
                        // è®¾ç½®é»˜è®¤ç”¨æˆ·ID
                        window.currentUserId = '1';

                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¸¸å®¢æ¨¡å¼ï¼ˆæ£€æŸ¥æœåŠ¡å™¨ç«¯è¿”å›çš„ä¿¡æ¯æˆ–sessionStorageï¼‰
                        if (data.user && data.user.is_guest) {
                            userInfo.textContent = 'æ¸¸å®¢æ¨¡å¼';
                        } else if (sessionStorage.getItem('guestMode') === 'true') {
                            userInfo.textContent = 'æ¸¸å®¢æ¨¡å¼';
                        } else {
                            // å¦‚æœæ—¢ä¸æ˜¯ç™»å½•ç”¨æˆ·ä¹Ÿä¸æ˜¯æ¸¸å®¢ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                            console.log('æ—¢ä¸æ˜¯ç™»å½•ç”¨æˆ·ä¹Ÿä¸æ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
                            window.location.href = '/login/';
                            return;
                        }
                    }
                } else {
                    console.error('è·å–ç”¨æˆ·çŠ¶æ€å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                // é»˜è®¤æ˜¾ç¤ºæ¸¸å®¢æ¨¡å¼
                document.getElementById('userInfo').textContent = 'æ¸¸å®¢æ¨¡å¼';
                window.currentUserId = '1';
            }
        }

        // å¤„ç†é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                // å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œç›´æ¥æ¸…é™¤å¹¶è·³è½¬
                if (sessionStorage.getItem('guestMode') === 'true') {
                    sessionStorage.removeItem('guestMode');
                    window.location.href = '/login/';
                    return;
                }

                // æ­£å¸¸ç”¨æˆ·é€€å‡ºç™»å½•
                const response = await fetch('/users/api/logout/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });

                const data = await response.json();
                if (data.success) {
                    window.location.href = '/login/';
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                // å³ä½¿å¤±è´¥ä¹Ÿè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login/';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                const response = await fetch('/users/api/logout/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
        }

        // getCookieå‡½æ•°å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰

        // è°ƒè¯•ï¼šç¡®è®¤æ‰€æœ‰å‡½æ•°å·²å®šä¹‰
        console.log('æ‰€æœ‰JavaScriptå‡½æ•°å®šä¹‰å®Œæˆ');
        console.log('toggleQuestionCount å‡½æ•°:', typeof toggleQuestionCount);
        console.log('startQuestionGeneration å‡½æ•°:', typeof startQuestionGeneration);
        console.log('checkUserStatus å‡½æ•°:', typeof checkUserStatus);

        // æ·»åŠ å˜é‡æ£€æŸ¥å‡½æ•°
        window.checkVariables = function() {
            console.log('ğŸ” æ£€æŸ¥å…¨å±€å˜é‡çŠ¶æ€:');
            console.log('selectedQuestionTypes:', selectedQuestionTypes);
            console.log('userPreferences:', userPreferences);
            console.log('isGenerating:', isGenerating);
            console.log('currentQuestions:', currentQuestions);
            console.log('currentQuestionIndex:', currentQuestionIndex);
        };

        // æ·»åŠ è¯¦ç»†è°ƒè¯•å‡½æ•°
        window.debugAPI = async function() {
            console.log('ğŸ”§ å¼€å§‹è¯¦ç»†è°ƒè¯•API...');

            // æ£€æŸ¥å…¨å±€å˜é‡
            console.log('å…¨å±€å˜é‡çŠ¶æ€:');
            console.log('- selectedQuestionTypes:', selectedQuestionTypes);
            console.log('- userPreferences:', userPreferences);
            console.log('- isGenerating:', isGenerating);

            const testData = {
                "selected_types": {
                    "multipleChoice": {
                        "name": "é€‰æ‹©é¢˜",
                        "count": 1
                    }
                },
                "preferences": "è¯·ç”ŸæˆåŸºç¡€éš¾åº¦çš„é¢˜ç›®",
                "requirement_text": "è¯·ç”Ÿæˆ1é“é€‰æ‹©é¢˜"
            };

            console.log('æµ‹è¯•æ•°æ®:', testData);
            console.log('JSONå­—ç¬¦ä¸²:', JSON.stringify(testData));

            // æ£€æŸ¥CSRF token
            const csrfToken = getCookie('csrftoken');
            console.log('CSRF token:', csrfToken ? csrfToken.substring(0, 20) + '...' : 'null');

            try {
                console.log('å‘é€è¯·æ±‚...');
                const response = await fetch('/questions/generate-structured/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(testData)
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”çŠ¶æ€æ–‡æœ¬:', response.statusText);
                console.log('å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… APIè°ƒè¯•æˆåŠŸ:', data);
                    return data;
                } else {
                    console.log('âŒ APIè°ƒè¯•å¤±è´¥ - çŠ¶æ€ç :', response.status);

                    // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                    try {
                        const errorJson = await response.json();
                        console.log('é”™è¯¯JSON:', errorJson);
                    } catch {
                        const errorText = await response.text();
                        console.log('é”™è¯¯æ–‡æœ¬:', errorText);
                    }
                    return null;
                }
            } catch (error) {
                console.log('âŒ APIè°ƒè¯•å¼‚å¸¸:', error);
                console.log('å¼‚å¸¸è¯¦æƒ…:', error.message);
                console.log('å¼‚å¸¸å †æ ˆ:', error.stack);
                return null;
            }
        };

        // æ·»åŠ æ¨¡æ‹Ÿæ­£å¸¸æµç¨‹çš„å‡½æ•°
        window.simulateNormalFlow = async function() {
            console.log('ğŸ¯ æ¨¡æ‹Ÿæ­£å¸¸å‡ºé¢˜æµç¨‹...');

            // æ¨¡æ‹Ÿè®¾ç½®é€‰æ‹©çš„é¢˜å‹
            selectedQuestionTypes = {
                "multipleChoice": {
                    "name": "é€‰æ‹©é¢˜",
                    "count": 1
                }
            };

            userPreferences = "è¯·ç”ŸæˆåŸºç¡€éš¾åº¦çš„é¢˜ç›®";

            console.log('è®¾ç½®çš„å˜é‡:', {
                selectedQuestionTypes,
                userPreferences
            });

            // è°ƒç”¨å®é™…çš„ç”Ÿæˆå‡½æ•°
            try {
                await generateQuestions();
                console.log('âœ… æ¨¡æ‹Ÿæµç¨‹å®Œæˆ');
            } catch (error) {
                console.log('âŒ æ¨¡æ‹Ÿæµç¨‹å¤±è´¥:', error);
            }
        };

        // æ·»åŠ ç”¨æˆ·IDæ£€æŸ¥å‡½æ•°
        window.checkUserId = async function() {
            console.log('ğŸ” æ£€æŸ¥å½“å‰ç”¨æˆ·ID...');

            try {
                const response = await fetch('/questions/generate-structured/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        "debug_mode": true,
                        "selected_types": {
                            "multipleChoice": {
                                "name": "é€‰æ‹©é¢˜",
                                "count": 1
                            }
                        }
                    })
                });

                console.log('è°ƒè¯•å“åº”çŠ¶æ€:', response.status);
                const result = await response.text();
                console.log('è°ƒè¯•å“åº”å†…å®¹:', result);

            } catch (error) {
                console.log('è°ƒè¯•è¯·æ±‚å¼‚å¸¸:', error);
            }
        };

        // æ·»åŠ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å‡½æ•°
        window.checkUserAuth = async function() {
            console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€...');

            try {
                const response = await fetch('/users/api/current-user/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('ç”¨æˆ·APIå“åº”:', response.status);

                if (response.ok) {
                    const userData = await response.json();
                    console.log('ç”¨æˆ·æ•°æ®:', userData);
                } else {
                    console.log('ç”¨æˆ·æœªè®¤è¯æˆ–APIé”™è¯¯');
                }
            } catch (error) {
                console.log('ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å¼‚å¸¸:', error);
            }
        };

        // æ·»åŠ æµ‹è¯•ç­”é¢˜è®°å½•å‡½æ•°
        window.createTestAnswerRecord = async function() {
            console.log('ğŸ§ª åˆ›å»ºæµ‹è¯•ç­”é¢˜è®°å½•...');

            const sessionId = generateSessionId();
            console.log('ä½¿ç”¨session_id:', sessionId);

            // åˆ›å»ºæµ‹è¯•ç­”é¢˜è®°å½•
            const testAnswers = [
                {
                    session_id: sessionId,
                    question_index: 0,
                    question_type: 'é€‰æ‹©é¢˜',
                    question_text: 'æµ‹è¯•é¢˜ç›®1',
                    user_answer: 'A',
                    correct_answer: 'A',
                    time_spent: 30
                },
                {
                    session_id: sessionId,
                    question_index: 1,
                    question_type: 'é€‰æ‹©é¢˜',
                    question_text: 'æµ‹è¯•é¢˜ç›®2',
                    user_answer: 'B',
                    correct_answer: 'C',
                    time_spent: 45
                }
            ];

            // æäº¤æµ‹è¯•ç­”æ¡ˆ
            for (let i = 0; i < testAnswers.length; i++) {
                try {
                    const response = await fetch('/questions/submit-answer/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(testAnswers[i])
                    });

                    const result = await response.json();
                    console.log(`æµ‹è¯•ç­”æ¡ˆ${i+1}æäº¤ç»“æœ:`, result);
                } catch (error) {
                    console.log(`æµ‹è¯•ç­”æ¡ˆ${i+1}æäº¤å¤±è´¥:`, error);
                }
            }

            console.log('âœ… æµ‹è¯•ç­”é¢˜è®°å½•åˆ›å»ºå®Œæˆï¼Œç°åœ¨å¯ä»¥æµ‹è¯•ç­”é¢˜æŠ¥å‘Šäº†');
        };

        console.log('è°ƒè¯•å‡½æ•°å·²æ·»åŠ :');
        console.log('- debugAPI(): è¯¦ç»†æµ‹è¯•API');
        console.log('- checkVariables(): æ£€æŸ¥å˜é‡çŠ¶æ€');
        console.log('- simulateNormalFlow(): æ¨¡æ‹Ÿæ­£å¸¸æµç¨‹');
        console.log('- checkUserAuth(): æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€');
        console.log('- createTestAnswerRecord(): åˆ›å»ºæµ‹è¯•ç­”é¢˜è®°å½•');

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
            setTimeout(function() {
                // åˆå§‹åŒ–é¢˜å‹æ§åˆ¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const types = ['multipleChoice', 'fillBlank', 'trueOrFalse', 'shortAnswer'];
                types.forEach(type => {
                    try {
                        // æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
                        if (typeof toggleQuestionCount === 'function') {
                            // åˆå§‹åŒ–æ—¶è§¦å‘ä¸€æ¬¡åˆ‡æ¢å‡½æ•°ï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®
                            toggleQuestionCount(type);
                        } else {
                            console.error('toggleQuestionCount å‡½æ•°æœªå®šä¹‰');
                        }
                    } catch (error) {
                        console.error('åˆå§‹åŒ–é¢˜å‹æ§åˆ¶å¤±è´¥:', type, error);
                    }
                });

                try {
                    if (typeof checkUserStatus === 'function') {
                        checkUserStatus();
                        console.log('ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆ');
                    } else {
                        console.error('checkUserStatus å‡½æ•°æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                }

                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }, 100); // å»¶è¿Ÿ100æ¯«ç§’
        });
    </script>
</body>
</html>